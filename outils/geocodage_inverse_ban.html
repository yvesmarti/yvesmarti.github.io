<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©ocodage Invers√© - BAN</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        /* Style pour rendre l'interface agr√©able */
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #0053b3;
            text-align: center;
        }
        .upload-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px dashed #0053b3;
            border-radius: 5px;
            text-align: center;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        button {
            background-color: #0053b3;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #003d82;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .info-box {
            background-color: #e3f2fd;
            padding: 15px;
            border-left: 4px solid #0053b3;
            margin: 20px 0;
        }
        .progress {
            margin: 20px 0;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #0053b3;
            width: 0%;
            transition: width 0.3s;
            text-align: center;
            line-height: 30px;
            color: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #0053b3;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .results-section {
            margin-top: 30px;
            display: none;
        }
        .error {
            color: #d32f2f;
            font-weight: bold;
        }
        .success {
            color: #388e3c;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó∫Ô∏è G√©ocodage Invers√© avec la BAN</h1>
        
        <div class="info-box">
            <strong>Comment utiliser cet outil :</strong>
            <ol>
                <li>Pr√©parez un fichier CSV avec des colonnes <strong>latitude</strong> et <strong>longitude</strong></li>
                <li>Cliquez sur "Choisir un fichier" et s√©lectionnez votre CSV</li>
                <li>Cliquez sur "Lancer le g√©ocodage"</li>
                <li>Attendez que l'outil r√©cup√®re toutes les adresses</li>
                <li>T√©l√©chargez le r√©sultat avec le bouton en bas</li>
            </ol>
        </div>

        <!-- Section pour charger le fichier -->
        <div class="upload-section">
            <h2>üìÅ Charger votre fichier CSV</h2>
            <input type="file" id="fileInput" accept=".csv">
            <br>
            <button id="processBtn" onclick="lancerGeoccodage()" disabled>Lancer le g√©ocodage</button>
            <p id="fileStatus"></p>
        </div>

        <!-- Aper√ßu du fichier charg√© -->
        <div class="results-section" id="previewSection">
            <h2>üëÅÔ∏è Aper√ßu de votre fichier</h2>
            <div id="previewContainer"></div>
        </div>

        <!-- Barre de progression -->
        <div class="progress" id="progressContainer">
            <h3>‚è≥ Traitement en cours...</h3>
            <p id="statusText" style="font-weight: bold; color: #0053b3;">Initialisation...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <p id="progressText">0 / 0 adresses trait√©es</p>
            <p id="speedText" style="font-size: 0.9em; color: #666;"></p>
        </div>

        <!-- Section des r√©sultats -->
        <div class="results-section" id="resultsSection">
            <h2>üìä R√©sultats du g√©ocodage</h2>
            <button onclick="telechargerResultats()">üíæ T√©l√©charger les r√©sultats (CSV)</button>
            <div id="tableContainer"></div>
        </div>
    </div>

    <script>
        // Variable globale pour stocker les donn√©es
        let donneesCSV = [];
        let resultatsGeocodes = [];

        // Quand l'utilisateur s√©lectionne un fichier
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const fichier = e.target.files[0];
            if (fichier) {
                document.getElementById('fileStatus').innerHTML = '<em>‚è≥ Chargement du fichier...</em>';
                
                // Parse le fichier CSV avec PapaParse
                Papa.parse(fichier, {
                    header: true,  // La premi√®re ligne contient les noms de colonnes
                    dynamicTyping: true,  // Convertit automatiquement les nombres
                    skipEmptyLines: true,  // Ignore les lignes vides
                    complete: function(results) {
                        donneesCSV = results.data;
                        console.log('Fichier charg√© :', donneesCSV.length, 'lignes');
                        
                        // Affiche un message de succ√®s
                        document.getElementById('fileStatus').innerHTML = 
                            `<span class="success">‚úÖ Fichier charg√© avec succ√®s : ${donneesCSV.length} lignes trouv√©es</span>`;
                        
                        // Affiche l'aper√ßu du fichier
                        afficherApercu();
                        
                        // Active le bouton de traitement
                        document.getElementById('processBtn').disabled = false;
                    },
                    error: function(error) {
                        document.getElementById('fileStatus').innerHTML = 
                            `<span class="error">‚ùå Erreur : ${error.message}</span>`;
                    }
                });
            }
        });

        // Fonction pour afficher un aper√ßu du fichier charg√©
        function afficherApercu() {
            if (donneesCSV.length === 0) return;
            
            document.getElementById('previewSection').style.display = 'block';
            
            // Affiche les 5 premi√®res lignes
            let tableHTML = '<p><strong>Premi√®res lignes de votre fichier :</strong></p><table><thead><tr>';
            
            const colonnes = Object.keys(donneesCSV[0]);
            colonnes.forEach(col => {
                tableHTML += `<th>${col}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';

            const lignesAafficher = Math.min(donneesCSV.length, 5);
            for (let i = 0; i < lignesAafficher; i++) {
                tableHTML += '<tr>';
                colonnes.forEach(col => {
                    const valeur = donneesCSV[i][col] || '';
                    tableHTML += `<td>${valeur}</td>`;
                });
                tableHTML += '</tr>';
            }

            tableHTML += '</tbody></table>';
            
            if (donneesCSV.length > 5) {
                tableHTML += `<p><em>... et ${donneesCSV.length - 5} autres lignes</em></p>`;
            }

            document.getElementById('previewContainer').innerHTML = tableHTML;
        }

        // Fonction principale pour lancer le g√©ocodage
        async function lancerGeoccodage() {
            // V√©rifie qu'il y a des donn√©es
            if (donneesCSV.length === 0) {
                alert('Aucune donn√©e √† traiter !');
                return;
            }

            // V√©rifie que les colonnes latitude et longitude existent
            const premiereLigne = donneesCSV[0];
            if (!('latitude' in premiereLigne) && !('lat' in premiereLigne)) {
                alert('‚ùå Colonne "latitude" (ou "lat") non trouv√©e dans le CSV !\n\nColonnes trouv√©es : ' + Object.keys(premiereLigne).join(', '));
                return;
            }
            if (!('longitude' in premiereLigne) && !('lon' in premiereLigne) && !('lng' in premiereLigne)) {
                alert('‚ùå Colonne "longitude" (ou "lon" ou "lng") non trouv√©e dans le CSV !\n\nColonnes trouv√©es : ' + Object.keys(premiereLigne).join(', '));
                return;
            }

            // D√©sactive le bouton pendant le traitement
            document.getElementById('processBtn').disabled = true;
            document.getElementById('processBtn').textContent = '‚è≥ Traitement en cours...';
            document.getElementById('progressContainer').style.display = 'block';
            
            // R√©initialise les r√©sultats
            resultatsGeocodes = [];
            
            // Variable pour calculer la vitesse
            const heureDebut = Date.now();

            // Boucle sur chaque ligne du CSV
            for (let i = 0; i < donneesCSV.length; i++) {
                const ligne = donneesCSV[i];
                
                // R√©cup√®re latitude et longitude (g√®re diff√©rents noms de colonnes)
                const lat = ligne.latitude || ligne.lat;
                const lon = ligne.longitude || ligne.lon || ligne.lng;

                // Met √† jour la barre de progression
                const pourcentage = Math.round(((i + 1) / donneesCSV.length) * 100);
                document.getElementById('progressFill').style.width = pourcentage + '%';
                document.getElementById('progressFill').textContent = pourcentage + '%';
                document.getElementById('progressText').textContent = `${i + 1} / ${donneesCSV.length} adresses trait√©es`;
                
                // Calcule et affiche la vitesse
                const tempsEcoule = (Date.now() - heureDebut) / 1000; // en secondes
                const vitesse = (i + 1) / tempsEcoule;
                const tempsRestant = (donneesCSV.length - i - 1) / vitesse;
                document.getElementById('speedText').textContent = 
                    `Vitesse : ${vitesse.toFixed(1)} adresses/seconde | Temps restant : ${Math.round(tempsRestant)}s`;

                // Met √† jour le statut avec l'adresse en cours
                document.getElementById('statusText').textContent = 
                    `üîç Recherche de l'adresse pour : ${lat}, ${lon}`;

                // Si les coordonn√©es sont pr√©sentes, appelle l'API
                if (lat && lon) {
                    try {
                        // Appel de l'API de g√©ocodage invers√© de la BAN
                        const url = `https://api-adresse.data.gouv.fr/reverse/?lon=${lon}&lat=${lat}`;
                        const reponse = await fetch(url);
                        const data = await reponse.json();

                        // Extrait les informations de l'adresse
                        if (data.features && data.features.length > 0) {
                            const feature = data.features[0];
                            const props = feature.properties;
                            
                            // Cr√©e un objet avec toutes les informations
                            resultatsGeocodes.push({
                                ...ligne,  // Garde toutes les colonnes d'origine
                                adresse: props.label || '',
                                numero: props.housenumber || '',
                                rue: props.street || '',
                                code_postal: props.postcode || '',
                                ville: props.city || '',
                                score: props.score || 0
                            });
                            
                            // Affiche l'adresse trouv√©e
                            document.getElementById('statusText').textContent = 
                                `‚úÖ Adresse trouv√©e : ${props.label || 'Inconnue'}`;
                        } else {
                            // Aucune adresse trouv√©e
                            resultatsGeocodes.push({
                                ...ligne,
                                adresse: 'Adresse non trouv√©e',
                                numero: '',
                                rue: '',
                                code_postal: '',
                                ville: '',
                                score: 0
                            });
                            document.getElementById('statusText').textContent = 
                                `‚ö†Ô∏è Aucune adresse trouv√©e pour ces coordonn√©es`;
                        }
                    } catch (erreur) {
                        console.error('Erreur pour la ligne', i, ':', erreur);
                        resultatsGeocodes.push({
                            ...ligne,
                            adresse: 'Erreur lors de la recherche',
                            numero: '',
                            rue: '',
                            code_postal: '',
                            ville: '',
                            score: 0
                        });
                        document.getElementById('statusText').textContent = 
                            `‚ùå Erreur lors de la recherche`;
                    }

                    // Petite pause pour ne pas surcharger l'API (50ms entre chaque requ√™te)
                    await new Promise(resolve => setTimeout(resolve, 50));
                } else {
                    // Coordonn√©es manquantes
                    resultatsGeocodes.push({
                        ...ligne,
                        adresse: 'Coordonn√©es manquantes',
                        numero: '',
                        rue: '',
                        code_postal: '',
                        ville: '',
                        score: 0
                    });
                    document.getElementById('statusText').textContent = 
                        `‚ö†Ô∏è Coordonn√©es manquantes`;
                }
            }

            // Affiche un message de fin
            document.getElementById('statusText').textContent = 
                `üéâ Traitement termin√© avec succ√®s !`;
            document.getElementById('statusText').style.color = '#388e3c';

            // Affiche les r√©sultats
            afficherResultats();
            document.getElementById('processBtn').disabled = false;
            document.getElementById('processBtn').textContent = 'Lancer le g√©ocodage';
        }

        // Fonction pour afficher les r√©sultats dans un tableau
        function afficherResultats() {
            document.getElementById('resultsSection').style.display = 'block';
            
            // Cr√©e le tableau HTML
            let tableHTML = '<table><thead><tr>';
            
            // En-t√™tes du tableau (toutes les colonnes)
            const colonnes = Object.keys(resultatsGeocodes[0]);
            colonnes.forEach(col => {
                tableHTML += `<th>${col}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';

            // Lignes du tableau (limite √† 100 pour ne pas surcharger)
            const lignesAafficher = Math.min(resultatsGeocodes.length, 100);
            for (let i = 0; i < lignesAafficher; i++) {
                tableHTML += '<tr>';
                colonnes.forEach(col => {
                    const valeur = resultatsGeocodes[i][col] || '';
                    tableHTML += `<td>${valeur}</td>`;
                });
                tableHTML += '</tr>';
            }

            tableHTML += '</tbody></table>';
            
            if (resultatsGeocodes.length > 100) {
                tableHTML += `<p><em>Affichage limit√© √† 100 lignes. Le fichier complet (${resultatsGeocodes.length} lignes) sera disponible au t√©l√©chargement.</em></p>`;
            }

            document.getElementById('tableContainer').innerHTML = tableHTML;
        }

        // Fonction pour t√©l√©charger les r√©sultats en CSV
        function telechargerResultats() {
            // Convertit les r√©sultats en CSV avec PapaParse
            const csv = Papa.unparse(resultatsGeocodes);
            
            // Cr√©e un fichier t√©l√©chargeable
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const lien = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            lien.setAttribute('href', url);
            lien.setAttribute('download', 'resultats_geocodage.csv');
            lien.style.visibility = 'hidden';
            document.body.appendChild(lien);
            lien.click();
            document.body.removeChild(lien);
        }
    </script>
    <!-- Bouton de retour vers la page des outils -->
<div style="text-align: center; margin: 30px 0; padding: 20px 0; border-top: 1px solid #ddd;">
    <a href="../outils.html" 
       style="display: inline-block; 
              padding: 12px 24px; 
              background-color: #007bff; 
              color: white; 
              text-decoration: none; 
              border-radius: 5px; 
              font-weight: bold;
              transition: background-color 0.3s;">
        ‚Üê Retour aux outils
    </a>
</div>
</body>
</html>
